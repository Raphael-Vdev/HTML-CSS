!function(){try{var e="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},r=(new Error).stack;r&&(e._sentryDebugIds=e._sentryDebugIds||{},e._sentryDebugIds[r]="6454aa9e-236a-4612-9062-9723ba549bdb",e._sentryDebugIdIdentifier="sentry-dbid-6454aa9e-236a-4612-9062-9723ba549bdb")}catch(e){}}();var _global="undefined"!==typeof window?window:"undefined"!==typeof global?global:"undefined"!==typeof self?self:{};_global.SENTRY_RELEASE={id:"4edc5f77"},(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[2628],{22011:function(e,r,n){n.d(r,{Z:function(){return l}});var t=n(66091),o=n(57988),i=n(81962),a=n(91620).lW,l=function(){"use strict";function e(r,n){if((0,t.Z)(this,e),this.asEncoding={},this.asBuffer=null,n&&"string"===typeof r)this.asEncoding[n]=r;else if(void 0===r||null===r)this.asBuffer=a.alloc(0);else if((0,i.Z)(r,a))this.asBuffer=r;else if("string"===typeof r)this.asEncoding.utf8=r;else if((0,i.Z)(r,ArrayBuffer))this.asBuffer=a.from(r);else{if((0,i.Z)(r,e))return r;(0,i.Z)(r,Uint8Array)?this.asBuffer=a.from(r):"object"!==typeof r||"object"!==typeof r.asEncoding||null===r.asEncoding||!(0,i.Z)(r.asBuffer,a)&&null!==r.asBuffer||(this.asBuffer=r.asBuffer||null,"string"===typeof r.asEncoding.base64&&(this.asEncoding={base64:r.asEncoding.base64}),"string"===typeof r.asEncoding.utf8&&(this.asEncoding={utf8:r.asEncoding.utf8}))}}var r=e.prototype;return r.toString=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"utf8";if(void 0!==this.asEncoding[e])return this.asEncoding[e];var r=this.toBuffer(),n=r.toString(e);return this.asEncoding[e]=n,n},r.toJSON=function(){return{asEncoding:{base64:this.toString("base64")},asBuffer:null}},r.toBuffer=function(){if(this.asBuffer)return this.asBuffer;for(var e in this.asEncoding){var r=this.asEncoding[e];if("string"===typeof r){var n=a.from(r,e);return this.asBuffer=n,n}}return this.asBuffer=a.alloc(0),this.asBuffer},e.from=function(r,n){return new e(r,n)},e.isBuffer=function(r){return(0,i.Z)(r,e)},(0,o.Z)(e,[{key:"length",get:function(){return void 0!==this.asEncoding.utf8?this.asEncoding.utf8.length:this.toBuffer().length}}]),e}()},8082:function(e,r,n){n.d(r,{F:function(){return i}});var t=n(81362),o=n(87708);function i(e,r){var n=[],i=!0,a=!1,l=void 0;try{for(var s,c=(0,t.Hg)(e.toString(),r.toString())[Symbol.iterator]();!(i=(s=c.next()).done);i=!0){var u=s.value,f=u.fromA,d=u.fromB,h=u.toA,p=u.toB;f===h&&n.push({from:f,insert:r.slice(d,p)}),d===p&&n.push({from:f,to:h,insert:""}),f!==h&&d!==p&&n.push({from:f,to:h,insert:r.slice(d,p)})}}catch(v){a=!0,l=v}finally{try{i||null==c.return||c.return()}finally{if(a)throw l}}return o.as.of(n,e.length)}},20575:function(e,r,n){n.d(r,{C:function(){return o},h:function(){return i}});var t=/^(\.env$|\.npm$|\.npm\/|__pycache__|\.cache|\.breakpoints|\.git$|\.git\/|\.upm$|\.upm\/|node_modules$|node_modules\/|_test_runner)/;function o(e){return t.test(e)}var i=[".git",".upm",".cache","__pycache__","node_modules","venv"]},32628:function(e,r,n){n.d(r,{Z:function(){return B}});var t=n(57135),o=n(72006),i=n(4405),a=n(55749),l=n(9970),s=n(96583),c=n(4561),u=n(22011),f=n(13630),d=n(70902),h=n(66091),p=n(5683),v=n(45347),g=n(72100),m=n(70090),y=n(51228),w=n(86763),C=n.n(w),E=n(70232);function D(e,r){var n=!0,t=!1,o=void 0;try{for(var i,a=r[Symbol.iterator]();!(n=(i=a.next()).done);n=!0){var l=i.value;switch(l){case c.Df.NotFound:if(e.includes("no such file"))return c.Df.NotFound;if(e.includes("file does not exist"))return c.Df.NotFound;break;case c.Df.AlreadyExists:if(e.includes("file exist"))return c.Df.AlreadyExists;break;case c.Df.NotDirectory:if(e.includes("not a directory"))return c.Df.NotDirectory;break;case c.Df.IsDirectory:if(e.includes("is a directory"))return c.Df.IsDirectory;break;case c.Df.InvalidPath:if(e.includes("absolute paths are not supported"))return c.Df.InvalidPath;break;case c.Df.DiskQuotaExceeded:if(e.includes("disk quota exceeded"))return c.Df.DiskQuotaExceeded;break;case c.Df.PermissionDenied:if(e.includes("permission denied"))return c.Df.PermissionDenied;break;case c.Df.FileSystemUnavailable:if(e.includes("input/output error"))return c.Df.FileSystemUnavailable;break;default:(0,E.Z)(l)}}}catch(s){t=!0,o=s}finally{try{n||null==a.return||a.return()}finally{if(t)throw o}}return null}var b=n(68282),S=n(87708);var k=n(68241),F=n(9353),_=n(70065),x=function(e){"use strict";(0,p.Z)(n,e);var r=(0,v.Z)(n);function n(e,a,l,p,v,g){var w;(0,h.Z)(this,n),(w=r.call(this)).writeChanges=function(e,r){if(!w.channel&&!w.isReconnecting)throw new Error("Trying to send changes before ever coming online");w.isReconnecting&&(w.didEditOffline=!0);var n=(0,b.ed)(e,w.localContent),t=n.op,i=n.docAfter;if(Math.random()<.1){var a=(0,b.f5)(y.type.apply(w.localContent,t)),l=e.apply((0,b.tT)(w.localContent));a===l.sliceString(0)&&a===(0,b.f5)(i)||w.onError("changeset to op mismatch",{originalError:null,changes:e,otContent:a,changeSetContent:l,docAfter:i})}var s,c="ghostwriter"===(null===(s=r)||void 0===s?void 0:s.author)?{author:f.api.OTPacket.Author.GHOSTWRITER}:{};w.metadata=(0,o.Z)({},w.metadata,c);try{w.pending=y.type.compose(w.pending,t)}catch(u){throw _.Z.wrap(u).setExtras({op:t,pending:w.pending})}w.localContent=i,0!==w.pending.length?w.emit("fileDirty"):w.commitPromise&&w.emit("commitStart"),w.debounceSend()},w.updateCursors=function(e){w.pendingCursors=e,w.debounceSend()},w.isClean=function(){return w.committedVersion===w.version&&0===w.inflight.length&&0===w.pending.length},w.onError=function(e,r){if(r.originalError){var n="string"===typeof r.originalError?r.originalError:r.originalError.message,t=D(n,[c.Df.NotFound,c.Df.IsDirectory,c.Df.DiskQuotaExceeded,c.Df.InvalidPath,c.Df.PermissionDenied,c.Df.FileSystemUnavailable]);if(t)return void w.emit("fsError",t,n)}w.destroy();var a=new Error("OT Error: "+e);w.emit("error",a,(0,i.Z)((0,o.Z)({},r),{filePath:w.linkedFile,version:w.version}))},w.sendOp=function(){if(w.channel&&"open"===w.channel.status&&!w.isReconnecting&&!(w.inflight.length>0)){if(0!==w.pending.length){var e=(0,b.gR)(w.pending);w.inflight=w.pending,w.pending=[],w.inflightOpsPromise=w.channel.request({ot:(0,o.Z)({spookyVersion:w.version,op:e},w.metadata)}),w.metadata={},w.inflightOpsPromise.then((function(r){r.error&&w.onError("error accepting packet",{originalError:r.error,op:e})}))}if(0!==w.pendingCursors.length){var r=!0,n=!1,t=void 0;try{for(var i,a=w.flushedCursorIds[Symbol.iterator]();!(r=(i=a.next()).done);r=!0){var l=i.value;w.channel.send({otDeleteCursor:{id:l}})}}catch(v){n=!0,t=v}finally{try{r||null==a.return||a.return()}finally{if(n)throw t}}w.flushedCursorIds=[];var s=!0,c=!1,u=void 0;try{for(var f,d=w.pendingCursors[Symbol.iterator]();!(s=(f=d.next()).done);s=!0){var h=f.value,p=Number(Math.random().toString().split(".")[1]).toString(36);w.flushedCursorIds.push(p),w.channel.send({otNewCursor:(0,o.Z)({id:p,user:w.user},h)})}}catch(v){c=!0,u=v}finally{try{s||null==d.return||d.return()}finally{if(c)throw u}}w.pendingCursors=[]}}},w.handlePacket=function(e,r){var n=e.op,t=e.version,o=e.crc32,i=r.overrideReconnectingBuffer;if(!w.isReconnecting||i)if(-1!==w.version){if(w.version++,t!==w.version){var a={originalError:null,expectedVersion:w.version,receivedVersion:t,incomingOp:n};return w.logger.error("OT Error: invalid server version",(0,k.P1)({details:a})),void w.onError("invalid server version",a)}try{w.serverContent=y.type.apply(w.serverContent,n)}catch(g){return void w.onError("unable to apply updated content",{originalError:g,incomingOp:n})}var l=m.str(w.serverContent)>>>0;if(l!==o){var s={originalError:null,incomingVersion:t,server:o,client:l,incomingOp:n};return w.logger.error("OT Error: crc32 mismatch",(0,k.P1)({details:s})),void w.onError("crc32 mismatch",s)}if(w.uncommittedOps.push({version:t,crc32:o,op:n}),w.dataloss&&w.shouldTrackDataLoss&&w.dataloss.storeOp({replId:w.replId,filePath:w.linkedFile.toString(),opType:"latestOp",op:{version:t,crc32:o},logger:w.logger,isReconnecting:w.isReconnecting}),JSON.stringify(n)===JSON.stringify(w.inflight))return w.dataloss&&w.shouldTrackDataLoss&&w.dataloss.storeOp({replId:w.replId,filePath:w.linkedFile.toString(),opType:"latestOwnOp",op:{version:t,crc32:o},logger:w.logger,isReconnecting:w.isReconnecting}),w.debounceCommit(),w.inflight=[],w.inflightOpsPromise=null,w.debounceSend(),void w.debounceSend.flush();if(w.commitPromise||w.emit("fileDirty"),w.debounceCommit(),w.hasUncommittedMultiplayerOps=!0,w.inflight.length){var c=y.type.transform(w.inflight,n,"right");n=y.type.transform(n,w.inflight,"left"),w.inflight=c}if(w.pending.length){var u=y.type.transform(w.pending,n,"right");n=y.type.transform(n,w.pending,"left"),w.pending=u}var f=(0,b.mt)(n,w.localContent),d=f.changes,h=f.docAfter;if(Math.random()<.1){var p=(0,b.f5)(y.type.apply(w.localContent,n)),v=d.apply((0,b.tT)(w.localContent));p===v.sliceString(0)&&p===(0,b.f5)(h)||w.onError("op to changeset mismatch",{originalError:null,op:n,otContent:p,changeSetContent:v,docAfter:h})}w.localContent=h,w.emit("changes",d)}else w.onError("Got packet while version is still -1, expected version to be set in handleStatus",{originalError:null});else w.bufferedReconnectingOps.push({crc32:o,op:n,version:t})},w.handleNewCursor=function(e){w.emit("cursor",e)},w.handleDeleteCursor=function(e){var r=e.id;w.emit("removeCursor",r)};var E=(0,d.Z)(w);w.handleStatus=function(){var e=(0,t.Z)((function(e){var r,n,t,o,i;return(0,s.__generator)(this,(function(a){switch(a.label){case 0:return E.channel&&"open"===E.channel.status?e.linkedFile?null==e.contents?(E.onError("expected status contents, got null or undefined",{originalError:null}),[2]):null==e.cursors?(E.onError("expected status cursors, got null or undefined",{originalError:null}),[2]):null==e.version?(E.onError("expected status version, got null or undefined",{originalError:null}),[2]):E.isReconnecting?(E.handleReconnect(e.contents,e.version),[2]):(E.dataloss&&E.shouldTrackDataLoss&&E.dataloss.checkAndTrack({serverContent:e.contents,serverVersion:e.version,replId:E.replId,filePath:E.linkedFile.toString(),fetchOps:E.fetchOps,logger:E.logger}),E.serverContent=e.contents,E.localContent=E.serverContent,E.version=e.version,E.emit("firstConnect"),E.emit("changes",S.as.of({from:0,insert:E.serverContent},0)),e.cursors.forEach(E.handleNewCursor),E.emit("fileDirty"),E.debounceCommit(),[2]):[4,E.channel.request({otLinkFile:{file:{path:E.linkedFile.toString()}}})]:[2];case 1:return(n=a.sent()).channelClosed?[2]:n.error?(E.onError("link file error "+n.error.replace(E.linkedFile.toString(),"$FILENAME"),{originalError:n.error}),[2]):n.otLinkFileResponse?(t=n.otLinkFileResponse.version,i=u.Z.from(null!==(o=null===(r=n.otLinkFileResponse.linkedFile)||void 0===r?void 0:r.content)&&void 0!==o?o:"").toString(),E.isReconnecting?(E.handleReconnect(i,t),[2]):(E.dataloss&&E.shouldTrackDataLoss&&E.dataloss.checkAndTrack({serverContent:i,serverVersion:t,replId:E.replId,filePath:E.linkedFile.toString(),fetchOps:E.fetchOps,logger:E.logger}),E.serverContent=i,E.localContent=E.serverContent,E.version=t,E.committedVersion=t,E.committedContent=E.serverContent,E.emit("firstConnect"),E.emit("changes",S.as.of({from:0,insert:E.serverContent},0)),[2])):(E.onError("unexpected link file response: "+JSON.stringify(n.toJSON()),{originalError:null}),[2])}}))}));return function(r){return e.apply(this,arguments)}}();var x=(0,d.Z)(w);w.handleReconnect=function(){var e=(0,t.Z)((function(e,r){var n,t,a,l,c,u,f,d,h,p,v,g,m,w,C,E,D,b,S,_,T,O,Z,R,P,M,N,I,L,B,A,U,V,q,Q,W,K,J,$,H,Y,j,z,G,X,ee,re,ne,te,oe,ie;return(0,s.__generator)(this,(function(s){switch(s.label){case 0:if(!x.timeDisconnected)throw new Error("wat");if(n=Date.now()-x.timeDisconnected,t={case:"other",remoteContent:e,localContent:x.localContent},a=function(t){x.reconnectTrackedData=(0,i.Z)((0,o.Z)({},t),{serverVersion:r,ourVersion:x.version,ourCommittedVersion:x.committedVersion,areContentsEqual:x.serverContent===e,areCommittedContentsEqual:x.committedContent===e,didReceiveOpsWhileReconnecting:Boolean(x.bufferedReconnectingOps.length),didEditOffline:x.didEditOffline,hasPendingOps:Boolean(x.pending.length),disconnectDuration:n});var a={};"has_inflight_happy_path_ops_reached"===t.case&&Math.random()<.1&&(a={hasAdditionalLogs:!0,ourContent:String(x.serverContent),ourCommittedContent:String(x.committedContent),ourInflight:JSON.stringify(x.inflight),ourPending:JSON.stringify(x.pending),serverContent:String(e)}),x.logger.info("OT Client: Reconnect",(0,k.P1)((0,o.Z)({},x.reconnectTrackedData,a))),x.track&&x.track(F.U3.FILE_RECONNECTED_STATUS2,x.reconnectTrackedData)},l=function(e,r){a({case:e,originCase:r,prompted:!1}),x.isReconnecting=!1,x.bufferedReconnectingOps=[],x.didEditOffline=!1,x.timeDisconnected=null,x.debounceSend(),x.debounceCommit(),x.emit("transparentReconnect",{case:e,originCase:r})},c=function(n){if(t.remoteContent===t.localContent)return x.version=r,x.committedVersion=r,x.localContent=e,x.committedContent=e,x.serverContent=e,x.inflight=[],x.pending=[],void l("unprompted_because_identical",n);a({case:n,prompted:!0}),t.case=n,x.emit("promptUserReconnect",t)},x.inflight.length){if(r===x.version&&x.serverContent===e)return x.pending=y.type.compose(x.inflight,x.pending),x.inflight=[],x.inflightOpsPromise=null,l("has_inflight_happy_path_ops_unreached"),[2];u=!1,f=x.serverContent;try{f=y.type.apply(f,x.inflight)}catch(ae){u=!0}return u||x.version+1!==r||f!==e?(c("has_inflight"),[2]):(c("has_inflight_happy_path_ops_reached"),[2])}if(x.hasUncommittedMultiplayerOps)return c("multiplayer"),[2];if(x.version===r)return e===x.serverContent?(l("happy_path"),[2]):(c("same_version_different_content"),[2]);if(x.committedVersion===r){d=e;try{h=!0,p=!1,v=void 0;try{for(g=x.uncommittedOps[Symbol.iterator]();!(h=(m=g.next()).done);h=!0)w=m.value.op,d=y.type.apply(d,w)}catch(le){p=!0,v=le}finally{try{h||null==g.return||g.return()}finally{if(p)throw v}}}catch(se){return c("same_committed_version_unable_to_apply_ops"),[2]}if(d===x.serverContent){C=[],E=!0,D=!1,b=void 0;try{for(S=x.uncommittedOps[Symbol.iterator]();!(E=(_=S.next()).done);E=!0)T=_.value.op,C=y.type.compose(C,T)}catch(le){D=!0,b=le}finally{try{E||null==S.return||S.return()}finally{if(D)throw b}}return x.pending=y.type.compose(C,x.pending),x.uncommittedOps=[],x.version=r,x.serverContent=e,l("happy_path_uncommitted"),[2]}return c("same_committed_version_different_content_fixed"),[2]}return x.version<r?[4,x.fetchOps(x.version+1,r)]:[3,3];case 1:O=s.sent(),Z=!1,R=x.serverContent;try{P=!0,M=!1,N=void 0;try{for(I=O[Symbol.iterator]();!(P=(L=I.next()).done);P=!0)B=L.value.op,R=y.type.apply(R,B)}catch(le){M=!0,N=le}finally{try{P||null==I.return||I.return()}finally{if(M)throw N}}}catch(ce){Z=!0}if(!Z&&R===e){A=!0,U=!1,V=void 0;try{for(q=O[Symbol.iterator]();!(A=(Q=q.next()).done);A=!0)W=Q.value,x.handlePacket(W,{overrideReconnectingBuffer:!0})}catch(le){U=!0,V=le}finally{try{A||null==q.return||q.return()}finally{if(U)throw V}}K=!0,J=!1,$=void 0;try{for(H=x.bufferedReconnectingOps[Symbol.iterator]();!(K=(Y=H.next()).done);K=!0)j=Y.value,x.handlePacket(j,{overrideReconnectingBuffer:!0})}catch(le){J=!0,$=le}finally{try{K||null==H.return||H.return()}finally{if(J)throw $}}return l("happy_path_server_ahead"),[2]}return[4,x.fetchOps(x.committedVersion+1,r)];case 2:z=s.sent(),G=!1,X=x.committedContent;try{ee=!0,re=!1,ne=void 0;try{for(te=z[Symbol.iterator]();!(ee=(oe=te.next()).done);ee=!0)ie=oe.value.op,X=y.type.apply(X,ie)}catch(le){re=!0,ne=le}finally{try{ee||null==te.return||te.return()}finally{if(re)throw ne}}}catch(ue){G=!0}return G||X!==e?(c("uncommitted_server_ahead"),[2]):(c("happy_path_uncommitted_server_ahead"),[2]);case 3:return c("other"),[2]}}))}));return function(r,n){return e.apply(this,arguments)}}();var T=(0,d.Z)(w);w.flush=function(){var e=(0,t.Z)((function(e){return(0,s.__generator)(this,(function(r){switch(r.label){case 0:return[4,T.commitPromise];case 1:return r.sent(),T.debounceCommit(e),T.debounceCommit.flush(),[4,T.commitPromise];case 2:return r.sent(),[2]}}))}));return function(r){return e.apply(this,arguments)}}();var O=(0,d.Z)(w);w.fetchOps=function(){var e=(0,t.Z)((function(e,r){var n;return(0,s.__generator)(this,(function(t){switch(t.label){case 0:if(!O.channel)throw new Error("No channel, cannot fetchOps");return[4,O.channel.request({otFetchRequest:{versionFrom:e,versionTo:r}})];case 1:if((n=t.sent()).channelClosed)throw new Error("Channel closed while requesting");if(n.error)throw new Error("Fetch ops returned an error: "+n.error);if(!n.otFetchResponse)throw new Error("Expected otFetchResponse");if(!n.otFetchResponse.packets)throw new Error("Expected otFetchResponse.packets");return[2,n.otFetchResponse.packets.map((function(e){var r=e.crc32,n=e.op,t=e.version,o=e.userId,i=e.committed,a=e.author;if(null==r)throw new Error("Expected crc32 in packet");if(null==n)throw new Error("Expected op in packet");if(null==t)throw new Error("Expected version in packet");return{crc32:r,version:t,op:(0,b.ug)(n),userId:o,timestamp:i?1e3*i.seconds:0,author:a}}))]}}))}));return function(r,n){return e.apply(this,arguments)}}();var Z=(0,d.Z)(w);w.fetchChanges=function(){var e=(0,t.Z)((function(e,r,n){var t,o;return(0,s.__generator)(this,(function(i){switch(i.label){case 0:return[4,Z.fetchOps(e,r)];case 1:return t=i.sent(),o=n,[2,t.map((function(e){var r=e.op,n=e.version,t=e.userId,i=e.timestamp,a=e.crc32,l=(0,b.mt)(r,o),s=l.changes,c=l.docAfter,u=s.invert((0,b.tT)(o));return o=c,{changes:s,invertedChanges:u,userId:t,version:n,timestamp:i,crc32:a}}))]}}))}));return function(r,n,t){return e.apply(this,arguments)}}();var R=(0,d.Z)(w);w.transformSelection=function(){var e=(0,t.Z)((function(e){var r,n,t,o,i,a,l,c;return(0,s.__generator)(this,(function(s){switch(s.label){case 0:if(r=e.indexStart,n=e.indexEnd,t=e.versionFrom,o=e.versionTo,!R.channel)throw new Error("No channel, cannot transformSelection");return[4,R.channel.request({otTransformSelectionRequest:{indexStart:r,indexEnd:n,versionFrom:t,versionTo:o}})];case 1:if(!(i=s.sent()).otTransformSelectionResponse)throw new Error("Expected otTransformSelectionResponse");return[2,{indexStart:null!==(a=i.otTransformSelectionResponse.indexStart)&&void 0!==a?a:0,indexEnd:null!==(l=i.otTransformSelectionResponse.indexEnd)&&void 0!==l?l:0,version:null!==(c=i.otTransformSelectionResponse.version)&&void 0!==c?c:0}]}}))}));return function(r){return e.apply(this,arguments)}}(),w.getLocalContent=function(){return(0,b.f5)(w.localContent)},w.getRawLocalContent=function(){return w.localContent},w.shouldTrackDataLoss=!1,w.replId="",w.linkedFile=e,w.channel=null,w.inflight=[],w.inflightOpsPromise=null,w.uncommittedOps=[],w.hasUncommittedMultiplayerOps=!1,w.committedVersion=-1,w.isReconnecting=!1,w.bufferedReconnectingOps=[],w.didEditOffline=!1,w.pending=[],w.metadata={},w.version=-1,w.serverContent="",w.localContent="",w.committedContent="",w.flushedCursorIds=[],w.pendingCursors=[],w.user=null,w.flushFailed=0,w.debounceSend=C()((function(){return w.sendOp()}),20,{maxWait:60}),w.debounceCommit=C()((function(e){return w.commitToDisk(e)}),1e3,{maxWait:3e3}),w.commitPromise=null,w.timeDisconnected=null;var P=!1;return w.destroy=function(){P=!0},w.logger=p,w.track=g,w.dataloss=v,l.then((function(){P||(w.destroy=a.openChannel({service:"ot",name:"ot:".concat(e)},(function(r){var n=r.channel,t=r.context;return w.shouldTrackDataLoss=!window.navigator.userAgent.includes("Firefox"),w.replId=t.repl.id,w.dataloss&&w.shouldTrackDataLoss&&w.dataloss.ensureTrackedFile({replId:w.replId,filePath:e.toString()}),w.user=t.currentUser?{name:t.currentUser.username,id:t.currentUser.id}:null,w.channel=n,n.onCommand((function(e){switch(e.body){case"ot":var r,n,t;if(!e.ot||null==e.ot.op||null==e.ot.spookyVersion||null==e.ot.crc32)return void w.onError("missing data in ot packet",{originalError:null,op:null===(r=e.ot)||void 0===r?void 0:r.op,spookyVersion:null===(n=e.ot)||void 0===n?void 0:n.spookyVersion,crc32:null===(t=e.ot)||void 0===t?void 0:t.crc32});if(-1===w.version)return;var o={crc32:e.ot.crc32,op:(0,b.ug)(e.ot.op),version:e.ot.spookyVersion};return w.handlePacket(o,{overrideReconnectingBuffer:!1});case"otstatus":return w.handleStatus(e.otstatus);case"error":if(e.ref)return;return w.onError("Unknown protocol error OT channel",{originalError:e.error||"no error"});case"otNewCursor":return w.handleNewCursor(e.otNewCursor);case"otDeleteCursor":return w.handleDeleteCursor(e.otDeleteCursor)}})),function(){w.channel=null,w.isReconnecting=!0,w.debounceSend.cancel(),w.debounceCommit.cancel(),w.timeDisconnected||(w.timeDisconnected=Date.now())}})))})),w}return n.prototype.commitToDisk=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},r=this;return(0,t.Z)((function(){var n,t,o,i,a,l;return(0,s.__generator)(this,(function(s){switch(s.label){case 0:if(!r.channel)throw new Error("Tryna commit while offline");if("open"!==r.channel.status)return[2];if(r.isReconnecting)throw new Error("Committing while reconnecting");return r.isClean()?[2]:r.commitPromise?(r.debounceCommit(e),[2]):(n=function(){},r.commitPromise=new Promise((function(e){return n=e})),r.inflightOpsPromise?[4,r.inflightOpsPromise]:[3,2]);case 1:if(s.sent().channelClosed)return r.commitPromise=null,n(),[2];s.label=2;case 2:return r.pending.length>0?(r.debounceSend(),r.debounceSend.flush(),r.inflightOpsPromise?[4,r.inflightOpsPromise]:(r.commitPromise=null,n(),r.onError("expected inflight promise",{originalError:null}),[2])):[3,4];case 3:if(s.sent().channelClosed)return r.commitPromise=null,n(),[2];s.label=4;case 4:return r.emit("commitStart"),t=r.version,o=r.serverContent,[4,r.channel.request({flush:e})];case 5:return(i=s.sent()).channelClosed?(r.flushFailed=0,r.commitPromise=null,n(),[2]):"ok"!==i.body?(r.commitPromise=null,n(),a=i.error||i.toString(),D(a,[c.Df.NotFound,c.Df.AlreadyExists,c.Df.NotDirectory,c.Df.IsDirectory,c.Df.DiskQuotaExceeded])?(r.onError("unable to flush",{originalError:a}),[2]):(r.flushFailed++,setTimeout((function(){r.isReconnecting||r.channel&&"open"===r.channel.status&&r.debounceCommit(e)}),Math.min(Math.random()*(Math.pow(2,r.flushFailed)-1)*1e3,1e3*Math.pow(2,10))),[2])):(r.dataloss&&r.shouldTrackDataLoss&&(l=r.uncommittedOps[r.uncommittedOps.length-1])&&r.dataloss.storeOp({replId:r.replId,filePath:r.linkedFile.toString(),op:{crc32:l.crc32,version:l.version},opType:"latestFlushedOp",logger:r.logger,isReconnecting:r.isReconnecting}),r.uncommittedOps=[],r.hasUncommittedMultiplayerOps=!1,r.committedVersion=t,r.committedContent=o,r.flushFailed=0,r.emit("commitComplete",t),r.isClean()&&r.emit("fileClean"),r.commitPromise=null,n(),[2,i])}}))}))()},n}(g.EventEmitter),T=x,O=n(20575),Z=n(91926),R=n(43182),P=n(12290),M=n(61871),N=n(8082);var I=n(38931),L=n(92404);function B(e){var r,n=e.container,d=e.dataloss,h=e.track,p=e.channelRequestPriority,v=function(e){b=!0,G.push(e),j(),e.then((function(){var r=G.indexOf(e);r>-1&&G.splice(r,1),H()}))},g=function(e){var r=!0,n=!1,t=void 0;try{for(var o,i=V[Symbol.iterator]();!(r=(o=i.next()).done);r=!0){(0,o.value)(e)}}catch(a){n=!0,t=a}finally{try{r||null==i.return||i.return()}finally{if(n)throw t}}},y=function(e){var r=new T(e,n,Promise.all((0,l.Z)(G).map((function(e){return e.catch((function(){}))}))).then((function(){})),n.logger,d,h);return r.on("commitComplete",H),r.on("fileDirty",j),r.on("fileClean",j),r.on("commitStart",j),r},w=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1e4,r=function(r){for(var n=arguments.length,o=new Array(n>1?n-1:0),i=1;i<n;i++)o[i-1]=arguments[i];if(t.length>=e)throw new Error("fs: We retried too many things during a closed channel.");return new Promise((function(e){t.push(e)})).then((function(){return r.apply(void 0,(0,l.Z)(o))}))},n=function(){t.splice(0,t.length).forEach((function(e){return e()}))},t=[];return{enqueue:r,flush:n}}(),C=w.enqueue,E=w.flush,b=!1,k=null,F=null,_=null,x=0,B=new Map,A=new Map,U=new Map,V=[];n.openChannel({service:"fsevents",priority:p},(function(e){var r=e.channel;k=r,r.onCommand((function(e){if("fileEvent"===e.body){if(!e.fileEvent)throw new Error("Expected fileEvent");var r=e.fileEvent,n=r.file,t=r.dest,o=r.op;if(n){var i=n.path;if(null!==i&&null!==o&&void 0!==i&&void 0!==o){var a,l=(0,L.S1)(i);if(H(),B.get(l)||n.type===f.api.File.Type.DIRECTORY)a=c.Tv.Directory;else{var s,u=Array.from(B.keys()).find((function(e){return(0,L.MO)(e,l)})),d=u&&(null===(s=B.get(u))||void 0===s?void 0:s.children.find((function(e){return e.filename===(0,L.Bf)(l)})));a=d?d.type:c.Tv.File}switch(o){case f.api.FileEvent.Op.Create:re({eventType:c.kS.Create,node:{path:l,type:a}});break;case f.api.FileEvent.Op.Modify:if(a===c.Tv.Directory)break;re({eventType:c.kS.Modify,node:{path:l,type:a}});break;case f.api.FileEvent.Op.Remove:re({eventType:c.kS.Delete,node:{path:l,type:a}});break;case f.api.FileEvent.Op.Move:if(null==t||null==t.path)throw new Error("Expected dest path");var h=t.path;re({eventType:c.kS.Move,node:{path:l,type:a},to:(0,L.S1)(h)})}}}}}));var n=(0,l.Z)(new Set((0,l.Z)(B.keys()).concat((0,l.Z)(A.keys()),(0,l.Z)(U.keys()))));return n.length&&r.send({subscribeFile:{files:n.map((function(e){return{path:e.toString()}}))}}),function(){k=null}}));var q=new Promise((function(e){return r=e}));n.openChannel({priority:p,service:function(e){return e.repl.currentUserPermissions.containerWrite?"gcsfiles":"files"}},(function(e){var n=e.channel;r(n),E();var t=(0,l.Z)(B.keys()).sort(),o=!0,i=!1,a=void 0;try{for(var s,u=function(){var e=s.value;oe.readDir(e).then((function(r){var n=B.get(e);if(n)if(r.error)re({eventType:c.kS.Delete,node:{path:e,type:c.Tv.Directory}});else{var t=r.children,o=n.children,i=o.filter((function(e){return!t.some((function(r){return r.filename===e.filename&&r.type===e.type}))})),a=!0,l=!1,s=void 0;try{for(var u,f=i[Symbol.iterator]();!(a=(u=f.next()).done);a=!0){var d=u.value;re({eventType:c.kS.Delete,node:{path:(0,L.K1)(e,d.filename),type:d.type}})}}catch(C){l=!0,s=C}finally{try{a||null==f.return||f.return()}finally{if(l)throw s}}var h=t.filter((function(e){return!o.some((function(r){return r.filename===e.filename&&r.type===e.type}))})),p=!0,v=!1,g=void 0;try{for(var m,y=h[Symbol.iterator]();!(p=(m=y.next()).done);p=!0){var w=m.value;re({eventType:c.kS.Create,node:{path:(0,L.K1)(e,w.filename),type:w.type}})}}catch(C){v=!0,g=C}finally{try{p||null==y.return||y.return()}finally{if(v)throw g}}}}))},f=t[Symbol.iterator]();!(o=(s=f.next()).done);o=!0)u()}catch(y){i=!0,a=y}finally{try{o||null==f.return||f.return()}finally{if(i)throw a}}var d=!0,h=!1,p=void 0;try{for(var v,g=function(){var e=v.value;oe.readFile(e,{fromDisk:!0}).then((function(r){var n=U.get(e);n&&(r.error?re({eventType:c.kS.Delete,node:{path:e,type:c.Tv.File}}):r.content.toBuffer().equals(n.latestContent.toBuffer())||re({eventType:c.kS.Modify,node:{path:e,type:c.Tv.File}}))}))},m=U.keys()[Symbol.iterator]();!(d=(v=m.next()).done);d=!0)g()}catch(y){h=!0,p=y}finally{try{d||null==m.return||m.return()}finally{if(h)throw p}}return function(){q=new Promise((function(e){return r=e}))}}));var Q=(0,M.Z)();Q.promise.catch((function(e){return e}));var W=(0,P.Z)((0,t.Z)((function(){var e;return(0,s.__generator)(this,(function(r){switch(r.label){case 0:return[4,Q.promise];case 1:return[4,r.sent().request({fsSnapshot:{}})];case 2:return(e=r.sent()).channelClosed?[2,{success:!1,error:"channel closed"}]:e.error?[2,{success:!1,error:e.error}]:[2,{error:null,success:!0}]}}))})),{wait:5e3,maxWait:1e4});n.openChannel({service:"snapshot",skip:function(e){return!e.repl.currentUserPermissions.containerWrite}},(function(e){var r=e.channel;return Q.resolve(r),function(){Q.isFulfilled&&(Q=(0,M.Z)()).promise.catch((function(e){return e}))}}));var K=c.kO.Clean,J=[],$=0;function H(){return Y.apply(this,arguments)}function Y(){return(Y=(0,t.Z)((function(){var e;return(0,s.__generator)(this,(function(r){switch(r.label){case 0:return $++,j(),[4,oe.persist()];case 1:return(e=r.sent()).error&&I.kg.error("Failed to persist, something very bad has probably happened",{originalError:e.error}),$--,j(),[2]}}))}))).apply(this,arguments)}function j(){return z.apply(this,arguments)}function z(){return(z=(0,t.Z)((function(){var e,r;return(0,s.__generator)(this,(function(n){return e=0===$&&0===G.length&&Array.from(A.values()).every((function(e){return e.otClient.isClean()})),r=K===c.kO.Clean,e===r||(K=e?c.kO.Clean:c.kO.Syncing,J.forEach((function(e){e(K,{hasUserChanged:b})}))),[2]}))}))).apply(this,arguments)}var G=[];function X(e,r){return ee.apply(this,arguments)}function ee(){return ee=(0,t.Z)((function(e,r){var n,o;return(0,s.__generator)(this,(function(i){return n=function(){var r=(0,t.Z)((function(){var r,t,o;return(0,s.__generator)(this,(function(i){switch(i.label){case 0:return[4,q];case 1:if("open"!==(r=i.sent()).status)return[2,C(n)];i.label=2;case 2:return i.trys.push([2,4,,5]),[4,r.request(e)];case 3:return t=i.sent(),[3,5];case 4:return o=i.sent(),R.Tb(new Error("Send request failed with error: ".concat(o))),[2,C(n)];case 5:return t.channelClosed?[2,C(n)]:[2,t]}}))}));return function(){return r.apply(this,arguments)}}(),o=n(),r.isMutative&&v(o),[2,o]}))})),ee.apply(this,arguments)}function re(e){_=null;var r=(0,L.DH)(e.node.path),n=B.get(r),t=(0,L.Bf)(e.node.path);if(!t)throw new Error("Expected filename");var a=null;if(e.eventType===c.kS.Move){var s=(0,L.DH)(e.to);a=B.get(s)}if(n||a)switch(e.eventType){case c.kS.Create:if(!n)break;var u=(0,l.Z)(n.children.filter((function(e){return e.filename!==t}))).concat([{type:e.node.type,filename:t}]),f=!0,d=!1,h=void 0;try{for(var p,v=n.listeners[Symbol.iterator]();!(f=(p=v.next()).done);f=!0){(0,p.value.onChange)(u)}}catch(Ce){d=!0,h=Ce}finally{try{f||null==v.return||v.return()}finally{if(d)throw h}}n.children=u;break;case c.kS.Move:var g=(0,L.Bf)(e.to);if(n&&n===a){var m=(0,l.Z)(n.children.filter((function(e){return e.filename!==t&&e.filename!==g}))).concat([{type:e.node.type,filename:g}]),y=!0,w=!1,C=void 0;try{for(var E,D=n.listeners[Symbol.iterator]();!(y=(E=D.next()).done);y=!0){(0,E.value.onChange)(m)}}catch(Ce){w=!0,C=Ce}finally{try{y||null==D.return||D.return()}finally{if(w)throw C}}n.children=m;break}if(n){var b=n.children.filter((function(e){return e.filename!==t})),S=!0,k=!1,F=void 0;try{for(var x,T=n.listeners[Symbol.iterator]();!(S=(x=T.next()).done);S=!0){(0,x.value.onChange)(b)}}catch(Ce){k=!0,F=Ce}finally{try{S||null==T.return||T.return()}finally{if(k)throw F}}n.children=b}if(a){var O=(0,l.Z)(a.children.filter((function(e){return e.filename!==t&&e.filename!==g}))).concat([{type:e.node.type,filename:g}]),Z=!0,P=!1,M=void 0;try{for(var N,I=a.listeners[Symbol.iterator]();!(Z=(N=I.next()).done);Z=!0){(0,N.value.onChange)(O)}}catch(Ce){P=!0,M=Ce}finally{try{Z||null==I.return||I.return()}finally{if(P)throw M}}a.children=O}break;case c.kS.Delete:if(!n)break;var V=n.children.filter((function(e){return e.filename!==t})),q=!0,Q=!1,W=void 0;try{for(var K,J=n.listeners[Symbol.iterator]();!(q=(K=J.next()).done);q=!0){(0,K.value.onChange)(V)}}catch(Ce){Q=!0,W=Ce}finally{try{q||null==J.return||J.return()}finally{if(Q)throw W}}n.children=V;break;case c.kS.Modify:break;default:throw new Error("unknown event")}switch(e.eventType){case c.kS.Move:case c.kS.Delete:var $=[A.get(e.node.path),U.get(e.node.path),B.get(e.node.path)],H=!0,Y=!1,j=void 0;try{for(var z,G=$[Symbol.iterator]();!(H=(z=G.next()).done);H=!0){var X=z.value;if(X){var ee=!0,ne=!1,te=void 0;try{for(var ie,ae=X.listeners[Symbol.iterator]();!(ee=(ie=ae.next()).done);ee=!0){var le=ie.value,se=le.onMoveOrDelete,ce=le.dispose;se&&se(e),ce()}}catch(Ce){ne=!0,te=Ce}finally{try{ee||null==ae.return||ae.return()}finally{if(ne)throw te}}}}}catch(Ce){Y=!0,j=Ce}finally{try{H||null==G.return||G.return()}finally{if(Y)throw j}}if(e.node.type===c.Tv.File)break;var ue=(0,l.Z)(new Set((0,l.Z)(B.keys()).concat((0,l.Z)(U.keys()),(0,l.Z)(A.keys())))).map((function(e){var r=A.get(e)||U.get(e)||B.get(e);if(!r)throw new Error("expected node");return r})),fe=[],de=!0,he=!1,pe=void 0;try{for(var ve,ge=ue.sort()[Symbol.iterator]();!(de=(ve=ge.next()).done);de=!0){var me=ve.value;if((0,L.X2)(e.node.path,me.path)){var ye=fe.slice(-1)[0];if(!ye||!(0,L.X2)(ye,me.path)){var we={eventType:c.kS.Delete,node:{path:me.path,type:me.type}};e.eventType===c.kS.Move&&(we=(0,i.Z)((0,o.Z)({},we),{eventType:c.kS.Move,to:(0,L.eB)(e.node.path,e.to,me.path)})),fe.push(me.path),re(we)}}}}catch(Ce){he=!0,pe=Ce}finally{try{de||null==ge.return||ge.return()}finally{if(he)throw pe}}break;case c.kS.Create:case c.kS.Modify:if(!U.has(e.node.path))break;oe.readFile(e.node.path,{fromDisk:!0}).then((function(r){var n=U.get(e.node.path);if(n)if(r.error)re({eventType:c.kS.Delete,node:{path:e.node.path,type:c.Tv.File}});else{n.latestContent=r.content;var t=!0,o=!1,i=void 0;try{for(var a,l=n.listeners[Symbol.iterator]();!(t=(a=l.next()).done);t=!0){var s=a.value.onChange;s&&s(r.content)}}catch(Ce){o=!0,i=Ce}finally{try{t||null==l.return||l.return()}finally{if(o)throw i}}}})).catch((function(e){e.message="File read after modify error: "+e.message,R.Tb(e)}))}}function ne(){return ne=(0,t.Z)((function(){var e,r,t,o,i,a,c,u,f;return(0,s.__generator)(this,(function(s){switch(s.label){case 0:if(!(o=null===(r=n.getContext())||void 0===r||null===(t=r.repl)||void 0===t?void 0:t.language))throw new Error("Expected repl language");return[4,(e=n).exec.apply(e,["rg","--hidden","--files"].concat((0,l.Z)(O.h.flatMap((function(e){return["--glob","!".concat(e)]})))))];case 1:return i=s.sent(),a=i.output,c=i.error,u=function(e){return!!e&&(!(0,O.C)(e)&&!Z.ZP.isLangFileBinary(o,e))},!c&&a?[2,_={error:null,files:a.split("\n").filter(u)}]:c&&c.includes("not found")?[4,n.exec("find",".","-type","f","-print0")]:[3,3];case 2:if((f=s.sent()).output)return[2,_={error:null,files:f.output.slice(2,-1).split("\0./").filter(u)}];s.label=3;case 3:return"exit status 1"!==c&&R.Tb(new Error("Find file command failed with error: ".concat(c))),[2,{error:c,files:null}]}}))})),ne.apply(this,arguments)}var te=function(){var e=(0,t.Z)((function(e,r,n){var o,i,a,l,u,f,d,h;function p(e){return v.apply(this,arguments)}function v(){return(v=(0,t.Z)((function(e){var r;return(0,s.__generator)(this,(function(n){switch(n.label){case 0:return[4,o.request(e)];case 1:if((r=n.sent()).channelClosed)throw new Error("channelClosed");if(r.error)throw new Error(r.error);return[2,r]}}))}))).apply(this,arguments)}return(0,s.__generator)(this,(function(t){switch(t.label){case 0:return[4,q];case 1:o=t.sent(),i={eventType:c.kS.Create,node:{path:e,type:c.Tv.File}},t.label=2;case 2:return t.trys.push([2,9,,10]),[4,p({transferStart:{path:e.toString(),size:r.length}})];case 3:if(!(a=t.sent().transfer))throw new Error("Failed to start a transfer (no transfer id)");l=r.toBuffer(),u=512e3,n(l.length,0),f=0,t.label=4;case 4:return f<Math.ceil(r.length/u)?[4,p({transferChunk:{id:a.id,content:l.subarray(f*u,(f+1)*u)}})]:[3,7];case 5:t.sent(),n(l.length,Math.min(l.length,(f+1)*u)),t.label=6;case 6:return f++,[3,4];case 7:return[4,p({transferComplete:{id:a.id,crc32:m.buf(l)}})];case 8:return t.sent(),[3,10];case 9:if("channelClosed"===(d=t.sent()).message)return[2,C(oe.transferFile,e,r,n)];if((h=D(d.message,[c.Df.NotDirectory,c.Df.AlreadyExists,c.Df.DiskQuotaExceeded]))===c.Df.DiskQuotaExceeded&&g(i),h===c.Df.AlreadyExists&&(h=c.Df.IsDirectory),h)return[2,{error:h}];throw d;case 10:return re(i),[2,{error:null}]}}))}));return function(r,n,t){return e.apply(this,arguments)}}(),oe={getStatus:function(){return K},onStatusChange:function(e){return J.push(e),function(){var r=J.indexOf(e);r>-1&&J.splice(r,1)}},watchDir:function(e,r){var n=!1,t=function(){n=!0;var r=B.get(e);r&&(r.listeners=r.listeners.filter((function(e){return e.dispose!==t})),0===r.listeners.length&&B.delete(e))};return oe.readDir(e).then((function(a){if(!n){if(a.error){var l=new Error(a.error);return l.code=a.error,r.onError(l),void t()}var s=B.get(e);s||(s={path:e,type:c.Tv.Directory,children:a.children,listeners:[]},B.set(e,s),k&&k.send({subscribeFile:{files:[{path:e.toString()}]}})),s.listeners.push((0,i.Z)((0,o.Z)({},r),{dispose:t})),r.onChange(a.children)}})).catch((function(e){t(),r.onError(e)})),t},watchPathStat:function(e,r){var n=0,t=!1,o=function(i,l,s){if(l===c.Tv.File)return function(){};var u=(0,a.Z)(s),f=u[0],d=u.slice(1),h=f===e;if(h&&0!==d.length)throw new Error("Invariant: child is target but has more children");var p=null,v=oe.watchDir(i,{onChange:function(i){var a=i.find((function(e){return e.filename===(0,L.Bf)(f)}));if(!a)return t||(r.onNewStat({exists:!1}),t=!0),void(p&&(p.dispose(),p=null));if(p&&a.type!==p.node.type&&(p.dispose(),p=null),!p)if(h){var l=++n;oe.stat(e).then((function(e){l===n&&e.exists&&(r.onNewStat(e),t=!1,p={node:a,dispose:function(){}})}))}else p={node:a,dispose:o(f,a.type,d)}},onError:r.onError});return function(){null===p||void 0===p||p.dispose(),v()}},i=(0,a.Z)((0,L.nV)(e)),l=i[0],s=i.slice(1);return o(l,c.Tv.Directory,s)},watchFilePath:function(e,r){var n,t=function(e,n){if(0===n.length){var o=oe.watchFile((0,L.S1)(e),r);return function(){o()}}var i,a=n[0],l=!1,s=oe.watchDir((0,L.S1)(e),{onChange:function(r){var o=r.find((function(e){return e.filename.toString()===a}));if(!l&&o)return i=t("".concat(e,"/").concat(a),n.slice(1)),void(l=!0);l=!1},onMoveOrDelete:function(){null===i||void 0===i||i()},onError:function(){}});return function(){null===i||void 0===i||i(),s()}},o=e.toString().split("/"),i=!1,a=oe.watchDir((0,L.S1)(""),{onChange:function(e){var r=e.find((function(e){return e.filename.toString()===o[0]}));if(!i&&r)return n=t(o[0],o.slice(1)),void(i=!0);i=!1},onError:function(){}});return function(){null===n||void 0===n||n(),a()}},writeFile:function(e,r){return(0,t.Z)((function(){var n,t,o,i,a,l;return(0,s.__generator)(this,(function(s){switch(s.label){case 0:return t="string"===typeof r?u.Z.from(r).toBuffer():r.toBuffer(),[4,X({write:{path:e.toString(),content:t}},{isMutative:!0})];case 1:if(o=s.sent(),a=null===(n=B.get((0,L.DH)(e)))||void 0===n?void 0:n.children.some((function(r){return r.filename===(0,L.Bf)(e)})),i=U.has(e)||A.has(e)||a?{eventType:c.kS.Modify,node:{path:e,type:c.Tv.File}}:{eventType:c.kS.Create,node:{path:e,type:c.Tv.File}},o.error){if((l=D(o.error,[c.Df.NotDirectory,c.Df.AlreadyExists,c.Df.DiskQuotaExceeded]))===c.Df.DiskQuotaExceeded&&g(i),l===c.Df.AlreadyExists&&(l=c.Df.IsDirectory),!l)throw new Error(o.error);return[2,{error:l}]}return re(i),[2,{error:null}]}}))}))()},transferFile:function(){for(var e=arguments.length,r=new Array(e),n=0;n<e;n++)r[n]=arguments[n];return(0,t.Z)((function(){var e;return(0,s.__generator)(this,(function(n){return e=te.apply(void 0,(0,l.Z)(r)),v(e),[2,e]}))}))()},readFile:function(e){var r=(arguments.length>1&&void 0!==arguments[1]?arguments[1]:{fromDisk:!1}).fromDisk;return(0,t.Z)((function(){var n,t,o;return(0,s.__generator)(this,(function(i){switch(i.label){case 0:return!r&&(n=A.get(e))&&n.otClient.getRawLocalContent()&&!n.otClient.isReconnecting?[2,{content:u.Z.from(n.otClient.getRawLocalContent()),error:null}]:[4,X({read:{path:e.toString()}},{isMutative:!1})];case 1:if((t=i.sent()).error){if(!(o=D(t.error,[c.Df.NotFound,c.Df.IsDirectory])))throw new Error(t.error);return[2,{error:o}]}if(!t.file||!t.file.path||!t.file.content)throw new Error("Expected file");return[2,{content:u.Z.from(t.file.content),error:null}]}}))}))()},createDir:function(e){return(0,t.Z)((function(){var r,n,t;return(0,s.__generator)(this,(function(o){switch(o.label){case 0:return[4,X({mkdir:{path:e.toString()}},{isMutative:!0})];case 1:if(r=o.sent(),n={eventType:c.kS.Create,node:{path:e,type:c.Tv.Directory}},r.error){if((t=D(r.error,[c.Df.NotDirectory,c.Df.DiskQuotaExceeded]))===c.Df.DiskQuotaExceeded&&g(n),!t)throw new Error(r.error);return[2,{error:t}]}return re(n),[2,{error:null}]}}))}))()},moveDir:function(e,r){return(0,t.Z)((function(){var n,t,o;return(0,s.__generator)(this,(function(i){switch(i.label){case 0:return[4,X({move:{oldPath:e.toString(),newPath:r.toString()}},{isMutative:!0})];case 1:if(n=i.sent(),t={eventType:c.kS.Move,node:{path:e,type:c.Tv.Directory},to:r},n.error){if((o=D(n.error,[c.Df.NotFound,c.Df.AlreadyExists,c.Df.NotDirectory,c.Df.DiskQuotaExceeded]))===c.Df.DiskQuotaExceeded&&g(t),!o)throw new Error(n.error);return[2,{error:o}]}return re(t),[2,{error:null}]}}))}))()},moveFile:function(e,r){return(0,t.Z)((function(){var n,t,o;return(0,s.__generator)(this,(function(i){switch(i.label){case 0:return[4,X({move:{oldPath:e.toString(),newPath:r.toString()}},{isMutative:!0})];case 1:if(n=i.sent(),t={eventType:c.kS.Move,node:{path:e,type:c.Tv.File},to:r},n.error){if((o=D(n.error,[c.Df.NotFound,c.Df.AlreadyExists,c.Df.NotDirectory,c.Df.DiskQuotaExceeded]))===c.Df.DiskQuotaExceeded&&g(t),!o)throw new Error(n.error);return[2,{error:o}]}return re(t),[2,{error:null}]}}))}))()},copyFile:function(e,r){return(0,t.Z)((function(){var n;return(0,s.__generator)(this,(function(t){switch(t.label){case 0:return[4,oe.readFile(e)];case 1:return(n=t.sent()).error?[2,n]:[2,oe.writeFile(r,n.content)]}}))}))()},copyDirFromRemote:function(e,r,n){return(0,t.Z)((function(){var t,o,i,a,l,u,f,d,h,p,v,g,m;return(0,s.__generator)(this,(function(s){switch(s.label){case 0:return[4,this.deleteDir(e)];case 1:return s.sent(),[4,n.readDir(e)];case 2:return(t=s.sent()).error?[2,t]:[4,this.readDir(r)];case 3:return(o=s.sent()).error!==c.Df.NotFound?[3,5]:[4,this.createDir(e)];case 4:return s.sent(),[3,6];case 5:if(o.error===c.Df.NotDirectory)return[2,o];s.label=6;case 6:i=!0,a=!1,l=void 0,s.label=7;case 7:s.trys.push([7,15,16,17]),u=t.children[Symbol.iterator](),s.label=8;case 8:return(i=(f=u.next()).done)?[3,14]:(d=f.value,h=(0,L.K1)(e,d.filename),d.type!==c.Tv.File?[3,11]:[4,n.readFile(h)]);case 9:return(p=s.sent()).error?[2,p]:[4,this.writeFile((0,L.K1)(r,d.filename),p.content)];case 10:return(v=s.sent()).error?[2,v]:[3,13];case 11:return d.type!==c.Tv.Directory?[3,13]:[4,this.copyDirFromRemote(h,(0,L.K1)(r,d.filename),n)];case 12:if((g=s.sent()).error)return[2,g];s.label=13;case 13:return i=!0,[3,8];case 14:return[3,17];case 15:return m=s.sent(),a=!0,l=m,[3,17];case 16:try{i||null==u.return||u.return()}finally{if(a)throw l}return[7];case 17:return[2,{error:null}]}}))})).apply(this)},copyFileFromRemote:function(e,r,n){return(0,t.Z)((function(){var t,o;return(0,s.__generator)(this,(function(i){switch(i.label){case 0:return[4,n.readFile(e)];case 1:return(t=i.sent()).error?[2,t]:[4,this.writeFile(r,t.content)];case 2:return(o=i.sent()).error?[2,o]:[2,{error:null}]}}))})).apply(this)},deleteFile:function(e){return(0,t.Z)((function(){var r,n;return(0,s.__generator)(this,(function(t){switch(t.label){case 0:return[4,X({remove:{path:e.toString()}},{isMutative:!0})];case 1:if((r=t.sent()).error){if(!(n=D(r.error,[c.Df.NotFound])))throw new Error(r.error);return[2,{error:n}]}return re({eventType:c.kS.Delete,node:{path:e,type:c.Tv.File}}),[2,{error:null}]}}))}))()},deleteDir:function(e){return(0,t.Z)((function(){var r,n;return(0,s.__generator)(this,(function(t){switch(t.label){case 0:return[4,X({remove:{path:e.toString()}},{isMutative:!0})];case 1:if((r=t.sent()).error){if(!(n=D(r.error,[c.Df.NotFound])))throw new Error(r.error);return[2,{error:n}]}return re({eventType:c.kS.Delete,node:{path:e,type:c.Tv.Directory}}),[2,{error:null}]}}))}))()},readDir:function(e){return(0,t.Z)((function(){var r,n,t;return(0,s.__generator)(this,(function(o){switch(o.label){case 0:return[4,X({readdir:{path:e.toString()}},{isMutative:!1})];case 1:if((n=o.sent()).error){if(!(t=D(n.error,[c.Df.NotFound,c.Df.NotDirectory,c.Df.FileSystemUnavailable])))throw new Error(n.error);return[2,{error:t}]}if(!(null===(r=n.files)||void 0===r?void 0:r.files))throw new Error("Expected filesChannel");return[2,{children:n.files.files.map((function(e){if(!e.path)throw new Error("Expected path");return{filename:(0,L.Bf)((0,L.S1)(e.path)),type:e.type===f.api.File.Type.DIRECTORY?c.Tv.Directory:c.Tv.File}})),error:null}]}}))}))()},stat:function(e){return(0,t.Z)((function(){var r;return(0,s.__generator)(this,(function(n){switch(n.label){case 0:return[4,X({stat:{path:e.toString()}},{isMutative:!1})];case 1:if((r=n.sent()).error)throw new Error(r.error);if(!r.statRes)throw new Error("expected stat result");return r.statRes.exists?r.statRes.type===f.api.File.Type.DIRECTORY?[2,{exists:!0,type:c.Tv.Directory,lastModified:new Date(1e3*r.statRes.modTime)}]:[2,{exists:!0,type:c.Tv.File,lastModified:new Date(1e3*r.statRes.modTime),byteLength:Number(r.statRes.size)}]:[2,{exists:!1}]}}))}))()},watchTextFile:function(e,r){var n=this,a=A.get(e);if(a||(a={path:e,type:c.Tv.File,listeners:[],otClient:y(e)},A.set(e,a)),!a)throw new Error("Expected watchedOtFile");var u=!1,f=!1,d=function(){},h=[],p=function(o){if(d(),!a)throw new Error("Expected watchedOtFile");var i=function(e){var n;return null===(n=r.onFlush)||void 0===n?void 0:n.call(r,e)};a.otClient.on("commitComplete",i);var m=function(){var e;return null===(e=r.onStatusChange)||void 0===e?void 0:e.call(r,c.KF.Dirty)};a.otClient.on("fileDirty",m);var w=function(){var e;return null===(e=r.onStatusChange)||void 0===e?void 0:e.call(r,c.KF.Clean)};a.otClient.on("fileClean",w);var C=function(){var e;return null===(e=r.onStatusChange)||void 0===e?void 0:e.call(r,c.KF.Syncing)};a.otClient.on("commitStart",C);var E=function(e){var n;return null===(n=r.onCursor)||void 0===n?void 0:n.call(r,e)};a.otClient.on("cursor",E);var D=function(e){var n;return null===(n=r.onRemoveCursor)||void 0===n?void 0:n.call(r,e)};a.otClient.on("removeCursor",D);var k=n,F=function(){var r=(0,t.Z)((function(r){var n,t,o,i,l,c,u,f,d,p,v;return(0,s.__generator)(this,(function(s){switch(s.label){case 0:if(!a)throw new Error("Expected watchedOtFile");return(n=a.otClient).destroy(),t=y(e),[4,new Promise((function(e,r){t.once("changes",(function(){return e()})),t.once("error",(function(e){return r(e)}))}))];case 1:if(s.sent(),o=n.getLocalContent(),i=t.getLocalContent(),l="local"===r?(0,N.F)(i,o):null,c="remote"===r?(0,N.F)(o,i):null,!a)throw new Error("Expected watchedOtFile");a.otClient=t,u=!0,f=!1,d=void 0;try{for(p=a.listeners[Symbol.iterator]();!(u=(v=p.next()).done);u=!0)(0,v.value.reregister)(c)}catch(m){f=!0,d=m}finally{try{u||null==p.return||p.return()}finally{if(f)throw d}}for(l&&t.writeChanges(l);h.length>0;){var g;null===(g=h.pop())||void 0===g||g({isDisposed:!1})}return[4,k.flush()];case 2:return s.sent(),[2]}}))}));return function(e){return r.apply(this,arguments)}}(),_=function(e){var n;return null===(n=r.onReconnectFail)||void 0===n?void 0:n.call(r,F,e)};a.otClient.on("promptUserReconnect",_),a.listeners[0].reregister===p&&a.otClient.on("promptUserReconnect",(function(){if(A.has(e)){if(!a)throw new Error("Expected watchedOtFile");a.listeners.some((function(e){return e.onReconnectFail}))||F("remote")}}));var x=function(e,n){r.onError&&r.onError(e,n),v()};a.otClient.on("error",x);var T=function(n,t){if(n===c.Df.DiskQuotaExceeded&&g({eventType:c.kS.Modify,node:{path:e,type:c.Tv.File}}),r.onError){var o=new Error(t);o.code=n,r.onError(o)}v()};a.otClient.on("fsError",T);var O=function(e,n){if(!a)throw new Error("Expected watchedOtFile");b=!0;var t=S.as.of(e,a.otClient.getLocalContent().length,"\n");a.otClient.writeChanges(t,n);var o=!0,i=!1,l=void 0;try{for(var s,u=a.listeners[Symbol.iterator]();!(o=(s=u.next()).done);o=!0){var f=s.value.onChange;f&&f!==r.onChange&&f({changes:t,changeSource:c.Fl.Local,version:a.otClient.version,latestContent:a.otClient.getLocalContent()})}}catch(d){i=!0,l=d}finally{try{o||null==u.return||u.return()}finally{if(i)throw l}}},Z=function(){var e=(0,t.Z)((function(){return(0,s.__generator)(this,(function(e){return(null===a||void 0===a?void 0:a.otClient.isReconnecting)?[2,new Promise((function(e,r){a?h.push(e):r(new Error("Expected watchedOtFile"))}))]:[2,{isDisposed:u}]}))}));return function(){return e.apply(this,arguments)}}(),R=function(){for(;h.length>0;){var e;null===(e=h.pop())||void 0===e||e({isDisposed:!1})}};a.otClient.on("transparentReconnect",R);var P,M=function(){var e=(0,t.Z)((function(){var e,r,n,t,o,i=arguments;return(0,s.__generator)(this,(function(s){switch(s.label){case 0:for(e=i.length,r=new Array(e),n=0;n<e;n++)r[n]=i[n];if(!a)throw new Error("Expected watchedOtFile");s.label=1;case 1:return s.trys.push([1,3,,4]),[4,Z()];case 2:return s.sent().isDisposed?[2,{isDisposed:!0,result:null}]:[3,4];case 3:if(o=s.sent(),u)return[2,{isDisposed:!0,result:null}];throw o;case 4:return[4,(t=a.otClient).fetchChanges.apply(t,(0,l.Z)(r))];case 5:return[2,{isDisposed:!1,result:s.sent()}]}}))}));return function(){return e.apply(this,arguments)}}(),I=function(){var e=(0,t.Z)((function(){var e,r,n,t,o=arguments;return(0,s.__generator)(this,(function(i){switch(i.label){case 0:for(e=o.length,r=new Array(e),n=0;n<e;n++)r[n]=o[n];if(!a)throw new Error("Expected watchedOtFile");return[4,Z()];case 1:if(i.sent().isDisposed)throw new Error("File was disposed");return[2,(t=a.otClient).transformSelection.apply(t,(0,l.Z)(r))]}}))}));return function(){return e.apply(this,arguments)}}(),L=function(e){if(!a)throw new Error("Expected watchedOtFile");a.otClient.updateCursors(e)};(-1!==a.otClient.version&&setTimeout((function(){var e;if(!f){if(!a)throw new Error("Expected watchedOtFile");f=!0,null===(e=r.onReady)||void 0===e||e.call(r,{initialContent:a.otClient.getLocalContent(),writeChange:O,updateSelections:L,fetchChanges:M,transformSelection:I,version:a.otClient.version})}})),o)&&(null===(P=r.onChange)||void 0===P||P.call(r,{changes:o,changeSource:c.Fl.Container,version:a.otClient.version,latestContent:a.otClient.getLocalContent()}));var B=function(e){var n,t;if(!a)throw new Error("Expected watchedOtFile");if(!f)return f=!0,void(null===(t=r.onReady)||void 0===t||t.call(r,{initialContent:a.otClient.getLocalContent(),writeChange:O,updateSelections:L,fetchChanges:M,transformSelection:I,version:a.otClient.version}));null===(n=r.onChange)||void 0===n||n.call(r,{changes:e,changeSource:c.Fl.Container,version:a.otClient.version,latestContent:a.otClient.getLocalContent()})};a.otClient.on("changes",B),d=function(){if(!a)throw new Error("Expected watchedOtFile");a.otClient.removeListener("commitComplete",i),a.otClient.removeListener("fileDirty",m),a.otClient.removeListener("fileClean",w),a.otClient.removeListener("commitStart",C),a.otClient.removeListener("error",x),a.otClient.removeListener("fsError",T),a.otClient.removeListener("changes",B),a.otClient.removeListener("cursor",E),a.otClient.removeListener("removeCursor",D),a.otClient.removeListener("promptUserReconnect",_),a.otClient.removeListener("transparentReconnect",R)},j()},v=function(){for(;h.length>0;){var r;null===(r=h.pop())||void 0===r||r({isDisposed:!0})}if(!u&&A.has(e)){if(u=!0,f=!0,d(),!a)throw new Error("Expected watchedOtFile");a.listeners=a.listeners.filter((function(e){return e.dispose!==v})),0===a.listeners.length&&(a.otClient.destroy(),A.delete(e))}};return a.listeners.push((0,i.Z)((0,o.Z)({},r),{dispose:v,reregister:p})),p(null),v},watchFile:function(e,r){var n=!1,t=function(){n=!0;var r=U.get(e);r&&(r.listeners=r.listeners.filter((function(e){return e.dispose!==t})),0===r.listeners.length&&U.delete(e))};return oe.readFile(e).then((function(a){if(!n){if(a.error){var l=new Error(a.error);return l.code=a.error,r.onError&&r.onError(l),void t()}var s=U.get(e);if(s||(s={path:e,type:c.Tv.File,listeners:[],latestContent:a.content},U.set(e,s),k&&k.send({subscribeFile:{files:[{path:e.toString()}]}})),!s)throw new Error("Expected watched file");s.listeners.push((0,i.Z)((0,o.Z)({},r),{dispose:t})),r.onChange(a.content)}})),t},listFiles:function(){return(0,t.Z)((function(){var e;return(0,s.__generator)(this,(function(r){switch(r.label){case 0:return _&&n.performance.now()-x<1e4?[2,_]:(F||(F=function(){return ne.apply(this,arguments)}(),x=n.performance.now()),[4,F]);case 1:return e=r.sent(),F=null,[2,e]}}))}))()},flush:function(e){var r=[],n=!0,t=!1,o=void 0;try{for(var i,a=A.values()[Symbol.iterator]();!(n=(i=a.next()).done);n=!0){var s=i.value;null!==s.otClient.channel&&(s.otClient.isReconnecting||r.push(s.otClient.flush(e)))}}catch(c){t=!0,o=c}finally{try{n||null==a.return||a.return()}finally{if(t)throw o}}return Promise.all((0,l.Z)(r).concat((0,l.Z)(G)).map((function(e){return e.catch((function(){}))}))).then((function(){}))},persist:function(e){var r=W();return e&&e.skipDebounce&&W.flush(),r},getOTVersion:function(e){var r=A.get(e);if(!r)throw new Error("No file with path ".concat(e," found."));return r.otClient.version},onDiskQuotaExceeded:function(e){return V.push(e),function(){V=V.filter((function(r){return r!==e}))}}};return oe}},68282:function(e,r,n){n.d(r,{ed:function(){return a},f5:function(){return c},gR:function(){return o},mt:function(){return l},tT:function(){return u},ug:function(){return i}});var t=n(87708);function o(e){return e.map((function(e){return"object"===typeof e?{delete:e.d}:"number"===typeof e?{skip:e}:{insert:e}}))}function i(e){return e.map((function(e){if("delete"in e&&e.delete)return{d:e.delete};if("skip"in e&&e.skip)return e.skip;if("insert"in e&&"string"===typeof e.insert)return e.insert;throw new Error("Unexpected op type")}))}function a(e,r){var n=[],t=r,o=0,i=0,a=0,l=0,s=function(e){var n=e-i;if(e<i)throw new Error("expected changeset to be ordered");for(var t=i+a;t<i+n+a;t++){var o=r.charCodeAt(t);o>=55296&&o<=57343?(l++,t++):13===o&&10===r.charCodeAt(t+1)&&(a++,t++)}i+=n};return e.iterChanges((function(e,r,c,u,f){if(e>0){var d=i+a,h=d-l;s(e);var p=i+a,v=p-l;n.push(v-h),o+=p-d}if(e!==r){var g=i+a,m=g-l;s(r);var y=i+a,w=y-l;n.push({d:w-m});var C=y-g;t=t.slice(0,o)+t.slice(o+C)}if(f.length){var E=f.sliceString(0);n.push(E),t=t.slice(0,o)+E+t.slice(o),o+=E.length}})),{op:n,docAfter:t}}function l(e,r){var n,o=[],i=r,a=0,l=0,s=0,c=0,f=function(e){for(var n=l+s;n<l+e+s;n++){var t=r.charCodeAt(n);t>=55296&&t<=57343?(s++,n++):13===t&&10===r.charCodeAt(n+1)&&(c++,n++)}l+=e},d=!0,h=!1,p=void 0;try{for(var v,g=e[Symbol.iterator]();!(d=(v=g.next()).done);d=!0){var m=v.value;if("string"===typeof m){var y=m;i=i.slice(0,a)+y+i.slice(a),a+=y.length;var w=l+s;if(y.endsWith("\r")&&"\n"===r.slice(w,w+1)&&0===(y=y.slice(0,-1)).length)continue;var C=u(y),E=w-c;(null===n||void 0===n?void 0:n.to)===E?n.insert=n.insert?n.insert.append(C):C:(n={from:w-c,insert:C},o.push(n))}else if("number"===typeof m){var D=s;f(m),a+=m+(s-D)}else if("d"in m){var b=l+s,S=c;f(m.d);var k=l+s,F=k-b;i=i.slice(0,a)+i.slice(a+F);var _=b-S,x=k-c;if("\r\n"===r.slice(b-1,b+1)&&(x-=1)-(_+=1)<=0)continue;(null===n||void 0===n?void 0:n.to)===_?n.to=x:(n={from:_,to:x},o.push(n))}}}catch(O){h=!0,p=O}finally{try{d||null==g.return||g.return()}finally{if(h)throw p}}if(l+s!==r.length){var T=r.slice(l+s);c+=T.split("\r\n").length-1}return{changes:t.as.of(o,r.length-c),docAfter:i}}var s=/\r\n?|\n/;function c(e){return e.replaceAll("\r\n","\n").replaceAll("\r","\n")}function u(e){return t.xv.of(e.split(s))}}}]);
//# sourceMappingURL=2628-5b8b8a8d851bb969.js.map